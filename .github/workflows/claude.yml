name: Claude Code

on:
    issue_comment:
        types: [created]
    pull_request_review_comment:
        types: [created]
    issues:
        types: [opened, assigned]
    pull_request_review:
        types: [submitted]

jobs:
    claude:
        if: |
            (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
            (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
            (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
            (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
        runs-on: ubuntu-latest
        permissions:
            contents: write
            pull-requests: write
            issues: write
            id-token: write
            actions: read # Required for Claude to read CI results on PRs
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6
              with:
                  fetch-depth: 1

            - name: Run Claude Code
              id: claude
              uses: anthropics/claude-code-action@v1
              with:
                  anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

                  # Configure Claude for Next.js + TypeScript + Supabase project
                  claude_args: |
                      --max-turns 20
                      --allowedTools "Read,Write,Edit,Glob,Grep,Bash(npm install),Bash(npm run build),Bash(npm run dev),Bash(npm run lint),Bash(npm run type-check),Bash(npm test),Bash(git status),Bash(git diff),Bash(git log)"
                      --append-system-prompt "
                      PROJECT: La Respuesta más Popular (Family Feud clone)
                      STACK: Next.js 14 App Router + TypeScript + Tailwind + Supabase

                      ## Available Skills (use /skill-name to invoke)
                      - /frontend-design - Creative UI design (avoid generic AI aesthetics)
                      - /nextjs-best-practices - Server/Client Components, routing, data fetching
                      - /nextjs-supabase-auth - Auth integration patterns
                      - /senior-security - Security audits and threat modeling
                      - /ux-researcher-designer - UX research and design patterns

                      ## Critical Project Rules (CLAUDE.md)
                      1. STRICT TypeScript - NO 'any', explicit return types
                      2. Server Components by default - 'use client' only when needed
                      3. Follow import order: external → @/ aliases → relative → types
                      4. TypeScript path aliases: @/components @/lib @/hooks @/types
                      5. Tailwind mobile-first + cn() utility for conditional classes
                      6. React Context + useReducer for game state management
                      7. Manual testing required before PR (game flow, persistence, UI/UX)
                      8. Git: feature/#<issue>-desc, commits: <type>: <desc>

                      ## Project Context
                      - Family Feud-style game (100 mexicanos dijeron)
                      - Dual mode: localStorage (no auth) + Supabase (with auth)
                      - Focus: game engine, scoring, UI polish
                      - Read CLAUDE.md fully before implementing

                      ## Workflow
                      1. Read issue/PR context carefully
                      2. Check CLAUDE.md for specific conventions
                      3. Use appropriate skill (e.g., /frontend-design for UI, /nextjs-best-practices for patterns)
                      4. Implement following strict TypeScript and project structure
                      5. Test manually if possible
                      6. Create clear commits with Co-Authored-By
                      "

                  # Environment settings for Next.js development
                  settings: |
                      {
                        "env": {
                          "NODE_ENV": "development"
                        }
                      }
